#!/usr/bin/env bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

progress() {
  echo -e "\033[44m\n${1}\n\033[0m"
}

parse_kbuild() {
  # Load config into shell variables
  eval `grep -o 'CONFIG[_A-Z0-9]* 1' include/autoconf.h | sed 's/ 1/=1/g'`

  for KBUILD in `find . -type f -name Kbuild`; do
    DIR=${KBUILD#./}
    DIR=${DIR%/*}
    cat $KBUILD | grep '^[^#].*\.o\b' | while read LINE; do
      FILE_LIST=${LINE#*+=}
      CONFIG=`echo ${LINE%+=*} | grep -o '$(.*)' | cut -d\( -f2 | cut -d\) -f1`
      eval [ -z \"$CONFIG\" -o \"\$$CONFIG\" = \"1\" ] && INCL=true || INCL=false
      if $INCL; then
        for FILE in `echo $FILE_LIST | grep -o '\S*\.o\b'`; do
          readlink -f $DIR/$FILE | sed "s:${CWD}/::" | sed 's/.o$/.c \\/g'
        done
      fi
    done
  done
}

generate_files() {
  # Copy config and make config
  progress "Generating configuration files"
  cp ${DIR}/busybox.config .config
  make oldconfig

  # Generate headers
  gcc applets/applet_tables.c -o applets/applet_tables
  applets/applet_tables include/applet_tables.h include/NUM_APPLETS.h
  gcc applets/usage.c -o applets/usage -Iinclude
  applets/usage_compressed include/usage_compressed.h applets
  scripts/mkconfigs include/bbconfigopts.h include/bbconfigopts_bz2.h
  scripts/generate_BUFSIZ.sh include/common_bufsiz.h

  progress "Generating Android_src.mk based on configs"

  # Process Kbuild files
  echo "LOCAL_SRC_FILES := \\" > Android_src.mk
  parse_kbuild | sort -u >> Android_src.mk

  # Build Android.mk
  echo 'LOCAL_PATH := $(call my-dir)' > Android.mk
  cat Makefile | head -n 3 >> Android.mk
  cat ${DIR}/busybox.mk >> Android.mk

  if $COMMIT; then
    progress "Commit headers and Makefiles"
    git add -f include/*.h
    git add -f *.mk
    git commit -m "Add generated files for ndk-build" -m "Auto generated by ndk-box-kitchen"
  fi
}

# git clone https://github.com/osm0sis/android-busybox-ndk busybox_patches
apply_patches() {
  if [ ! -d ${DIR}/busybox_patches ]; then
    progress "Please clone https://github.com/osm0sis/android-busybox-ndk to busybox_patches"
    exit 1
  fi
  for p in ${DIR}/busybox_patches/patches/* ${DIR}/busybox-ndk.patch; do
    case $p in
      *000*|*001*|*002*|*017-d*|*020* )
        # Skip several patches
        continue
        ;;
      * )
        MSG="`cat $p | grep 'Subject' | sed 's/.*]\s//'`"
        progress "[PATCH] $MSG"
        patch -p1 < $p
        git add .
        git commit -m "$MSG" -m "Auto generated by ndk-box-kitchen"
        ;;
    esac
  done
}

if [ ! -d busybox ]; then
  progress "Please clone busybox, checkout to desired tag, apply patches, then run this script"
  exit 1
fi

cd busybox
CWD="$( readlink -f ${DIR}/busybox )"

case "$1" in
  generate )
    [ "$2" = "--commit" ] && COMMIT=true || COMMIT=false
    generate_files
    ;;
  patch )
    apply_patches
    ;;
  * )
    echo "Usage:"
    echo "$0 patch"
    echo "   Apply patches for busybox"
    echo "$0 generate [--commit]"
    echo "   Generate Makefiles for compilation"
    ;;
esac

cd ${DIR}
